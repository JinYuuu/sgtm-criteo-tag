___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Criteo Tag",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAABACAYAAABLAmSPAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAVpSURBVGhD7Zt5bBVVGMXHfYkLATUaTXCJYlwSjTH+gTFqTIxb0EoqYEujDWURFxTTIJaoFCUiW0AFlEYU0VirAtKANlVLBBEEFaoggimyVBbLXmjrHOe799b3XuebeXe29r7gLzlpCI9z7+nMu+uHhWOE/4MmSvNBYP9uoHETcGAP0HpU/UVyJBfUtoGtvwI1s2G/ORgYcwdQcgmQdwLsPpZL6HsKMOxKYHwe7PdGAd8vAA7vV2bRiTdoWwuwejHs6cXAwHPZQEGEvBOBUTcDC6fINyAC8QT9ezvseWVA0Xlsh+MQPXH7tYeAjStVo8GIFrRpB+w3SpxOnMx2Lgnh/uOAl/sAf/yoOqFHuKA0eFSWA/3OYDvTGRLf9dlPyYFNg+BBG9YCI65jG+8KiQFu3deqc94EC7pkpvOanso22JUSg9b8SaqTPHpB/2mDXfE024hRmlwgR36G7EHbWmFPyOeNDZQYqFqOqM6n8A9KT3LSANbQZGHs3aLv6fgGtWc+xhrlgvBDtUoh8Q5aU8Ea5ILw4Ely+ZkGH5QmYwNHVx2h35nAqs9VkBTuoM7gg2duYE3iEgp7AMOvAp6/FRh5IzD4UuCB49nPBhFKLpbzPIM76KcTWJMoQvGFzg5miPxNHz2sGupAazNQX+esmcc4u5grWB8/obQ3sG+nMnOTGZT2hv3PYo3CCMUXAYtneM5tvvxUA5Tdxvq6NLWInVLSyQhqzx3NG4XROyPlU4rK8irgkQvYNuh1R9V49UF/UkEP7RVfZM4wiJB/OlA3T5nGxN6/xMY9ox1nQ4EVn6kPZCcV1FnHphuFEW3XsPYrZRgzzo7JnvaobGfIZRG2ac/e5Op4UOHLt5VZgtDTpZkhIDJo42a244FEo6rByKBfzOI7ryk6QhHfcYMRQaPuTlD1ijAzGflEB/VkA+hIDEART+g6AwtHDkVafmHsPcrKbCxsXsMG0BXmT1RWZmNh5UI2gK7wc62yMhuLVjFcAF1hZ4OyMhsr6orI9GmlHQvVr7MBdIXmA8rKbCzUzmED6IquJXIBC8s/YQPoCr+tUFZmY4ldPRNAV3T/mQtYtBvgAmhr6kBlZTbOI3Eo7MGH0BAKumc9xjABGbTsdjaErmI/UUgAGbSynA2gKzx5resKwDRk0A3fsQGCCIumCStTkUHpadDZKxNAV8g/zeipRgZ1sOc+xwYIIhSdn+zat3q6OPpE+b2+h9Uc/wXFjt9FIQQXIIgw9HJgS70yjYm2FthvPZ7ZDl3pe1w/cKSCEq/2zTALK3HRQwfPcbB1vecJJd0qYNUi9UF/MoPSbyiGy552iVds02plHhCqXaoYkbW0h6pTsGCy+kfeZAZ1sKcUsoZhJeqCxt0n7luzbgBoy0drbyqcogIqxs9TVO/kc8fjCop9u2Ipb+MkQtOcS1+RGUNhv1sqftKf8cQ1nnWCuqKFj7goY3AHJZZ+wBrlgsRguG2DCpKCD+pAFZmcUS4IhecAe7apJBLPoKIMrrQ3a5QLwrKPVRCJd1CCJmXnu8MZmSxRKtDhLMs/KCHCXs0amigM6wXs/lN1PkX2oARd1eXAa0zFmGhqVJ3ORC8o4Wyu6TSBa8AITewPcb3igX7QdmrnAAPO5hvrAlE9VKiVkRa7tojVDtdwZwqjb2HnTI5wQduhe5eEi684iVGV3iz6nxiaRAtKUGNrlgAv3RXLNs9PVGgliqND1C1FD5rO9o1A5Thn9Lue7WgY4eFusmCqvi7QE+xIvEHTobnsm/dhzxou6/0KurNB0iUW/YN6Ai/eCXz4ArB+WWyHbskF5TjYJOuDflkqX/dvP5I/KVDDukQvrDo3aBdyjAQF/gW2zQ/g7XwYVgAAAABJRU5ErkJggg\u003d\u003d"
  },
  "description": "SGTM Criteo Tag",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "applicationId",
    "displayName": "ApplicationId",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "partnerId",
    "displayName": "Partner ID (ex. 123456)",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// Imports
const sendHttpRequest = require('sendHttpRequest');
const getAllEventData = require('getAllEventData');
const getEventData = require('getEventData');
const JSON = require('JSON');

// Constants (do not forget to update the version
const tagVersion = 'criteo_sgtm_0.0.1';

// Implementation
const postHeaders = {'Content-Type': 'application/json'};
const mappingId = data.applicationId + '.' + getEventData('event_name');
const urlToCall = 'https://sslwidget.criteo.com/gtm/event?mappingId=' + mappingId;

const postBodyData = getAllEventData();
postBodyData.partner_id = data.partnerId;
postBodyData.version = tagVersion;
const postBody = JSON.stringify(postBodyData);


// Fire
sendHttpRequest(urlToCall, (statusCode, headers, body) => {
  if (statusCode >= 200 && statusCode < 300) {
    data.gtmOnSuccess();
  } else {
    data.gtmOnFailure();
  }
}, {headers: postHeaders, method: 'POST', timeout: 3000}, postBody);


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 30/08/2021, 17:10:47


